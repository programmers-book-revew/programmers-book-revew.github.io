---
layout: post
title: スケーラブルWebサイト
categories: rank_3
tags: [web, oreilly]
---


<div class="book"><div class="book_image"><a href="http://www.amazon.co.jp/dp/4873113113"><img src="/images/scalable_web_site.jpg"></img></a></div><div class="book_info">Cal Henderson/オライリー・ジャパン </div><div class="clear"></div></div>

Flickrの人。 

こうすればスケーラブルなWebサイトが作れる、という内容ではなく、そのためにはこういうことを考える必要もあるという項目を網羅的に紹介している。例えば、Javaと同じくPHPもスケーラブルと書いてある。概念的にはそうだろうけど、そういうのが知りたいのではなくてmod_phpの並列性がどうとか、そういうことを知りたい。 

最初の方は知っていることも多く8, 9章までは退屈だった(ちなみに全11章)。業務で扱っている人にはもっと退屈なことだろう。でも、フムリと思うことが出来ることもあって満足。 

例えば、ツリーレプリケーション(p.235,236) の箇所。マスターとスレーブ階層の中間層で、Usersテーブルなど一部の情報のみを抜きだし、他のindexなどの情報を持つものに比べMyISAMテーブルを使うことが出来るなど高速に実行可能にすることで、このテーブルを情報の読み書きに使うことで性能を向上させることが出来る。よくこんなこと考え付くなあ。 

以下、自分用メモ<!--more-->

サーバやデータセンタなどは、普段2つで動作させておくと1つ壊れた時にもう1つだとパワー不足になるので3つの方が良い(と直接は言ってないけど)。 

おすすめされてた、ハードウェアレベルでのスケーラブルの本。 
"Performance by Design: Computer Capacity Planning by Example"(Prentice Hall) 

> MTBF(平均故障間隔)は面白い数字で、間違って解釈されていることが多いものです。ドライブのMTBFが500,000時間(約57年)という場合、これは57年故障しないという意味ではありません。デバイスのサービス寿命も考慮する必要があります。MTBFが57年で、サービス寿命が1年のドライブがあるとします。サービス寿命にしたがって1年に1回ディスクを交換すれば57年間ドライブを故障せずに動作させることが出来るでしょう。一方、57台のディスクを1年間動作させた場合、1年以内に1台が故障することになると予想できます。サービス寿命(と保証期間!)は注意すべき重要な数値なのです。(p.148) 

“サービス寿命”なんて単語知らなかった。Googleしても微妙なので一般的な用語ではないみたい(そういう時はオリジナルの英単語も併記してほしい)。当たり前の用にMTBFの概念を間違って解釈していた。 
次の説明が一番分かり易かった。 [http://pc.watch.impress.co.jp/docs/2002/0920/key215.htm](http://pc.watch.impress.co.jp/docs/2002/0920/key215.htm) 

> PCでは、ディスクドライブなどの信頼性を表すためによく用いられており、数10万～100万時間という大きな値が示されていることが多い。このMTBF は、実際にこれだけの時間、故障することなく稼動しつづけるということを意味しているのではなく、あくまで、統計的に算出された値である。単純な例としては、例えば500台のサンプルを、想定する環境の10倍厳しい条件で(加速試験)100時間テスト。1台故障したので、MTBFは50万時間 (10×500台×100時間÷1台)というように算出する。したがって、MTBFが大きい方が信頼性は高いが、ユーザーにとって最も気になる「買った製品がいつ壊れるのか」ということを示しているわけではない。経年変化の少ない半導体パーツなら、長期に渡って数値通りの故障率を維持できるが、可動パーツは、日に日に故障率が高まって行く(もちろん使い方や環境にもよる)ことが、容易に予想できるだろう。 

迅速に返すために、チケットシステムを導入する。リクエストがあった時に、チケットサーバがチケットを返しクライアントにまずは返す。バックグラウンドでリモートサービスプロバイダの処理が終わるとチケットサーバに通知しそれをクローズさせる。クライアントはチケットステータスをWebサーバに問い合わせクローズされるまで定期的に繰り返す。 (p.152-153の内容を適当にまとめた) 

> プロトコルの独自開発は、多くの場合、良い考えではありません。ただし、限られた数の機能を持つ特定のドメインに依存したタスクにおいて、(速度の点についてなど)既存のプロトコルを避けた方が良い理由が十分にある場合は、独自プロトコルを作成することが成功への近道となる場合があります。 
Flickrで独自のプロトコルを作成する前に、まずNFSを、そしてSCPを採用したことはお知らせしておいた方が良いでしょう。これらのプロトコルの問題点に直面して初めて独自のプロトコルの実装を始めたのです。アプリケーションを構成する多くのコンポーネントにも共通しますが、まずは複雑で時間のかかることを避け、既存の他人の仕事を利用させてもらうことです。(p.162) 

> 同じハードウェア構成を使っているのであれば、マスタよりスレーブが読み込み能力が高くなるということはありません。この点は、見落としている人もいますが、かなり重要なことです。というのは、スレーブはマスタの行う書き込みをすべて行う必要があるため、スレーブは、マスタより強力ではないにしても、少なくともマスタと同じ能力を持ち合わせていなければならないからです。(p.234) MySQLのレプリケーション。マスターがスレーブに書き込みの内容を送信しスレーブがそれを実行することでレプリケーションを実現している。 

> ウェブサービス用のAPIはアプリケーションのコアの上にある、もう一つのプレゼンテーション層のひとつなのです。(p.302)
